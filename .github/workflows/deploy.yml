name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push image
        run: |
          IMAGE_TAG="ghcr.io/${{ github.repository }}:${{ github.sha }}"
          LATEST_TAG="ghcr.io/${{ github.repository }}:latest"

          echo "Building image: ${IMAGE_TAG}"
          podman build -t ${IMAGE_TAG} -t ${LATEST_TAG} .

          echo "Pushing image: ${IMAGE_TAG}"
          podman push ${IMAGE_TAG}

          echo "Pushing image: ${LATEST_TAG}"
          podman push ${LATEST_TAG}

      - name: Deploy to VM
        env:
          VM_SSH_KEY: ${{ secrets.VM_SSH_KEY }}
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER }}
          ENV_FILE_CONTENTS: ${{ secrets.ENV_FILE_CONTENTS }}
        run: |
          mkdir -p ~/.ssh
          echo "${VM_SSH_KEY}" | tr -d '\r' > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key

          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${VM_USER}@${VM_HOST} \
            "mkdir -p ~/.config/containers/systemd/ ~/.config/peeple-queue/"

          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
            deploy/peeple-queue.container \
            ${VM_USER}@${VM_HOST}:~/.config/containers/systemd/peeple-queue.container

          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${VM_USER}@${VM_HOST} "bash -s" <<EOF
            set -e

            echo "--> Updating environment variables..."
            echo "${ENV_FILE_CONTENTS}" > ~/.config/peeple-queue/.env

            echo "--> Reloading Systemd to detect Quadlet changes..."
            systemctl --user daemon-reload

            echo "--> Pulling latest image..."
            podman pull ghcr.io/${{ github.repository }}:latest

            echo "--> Restarting service..."
            systemctl --user restart peeple-queue

            echo "--> Verifying status..."
            systemctl --user status peeple-queue --no-pager

            echo "Deployment successful!"
          EOF
